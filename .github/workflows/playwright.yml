name: Playwright E2E CI with Allure Reporting

on:
  push:
    branches: [ EL-27-Playwright, EL-33-BUG-No-Videos-or-Screenshots-in-Allure ]
  pull_request:
    branches: [ EL-27-Playwright, EL-33-BUG-No-Videos-or-Screenshots-in-Allure ]

jobs:
  # -----------------------------------------------------------------------------
  # 1. Distributed Playwright Test Execution (Sharded for Scalability)
  # -----------------------------------------------------------------------------
  playwright:
    name: Playwright Shard ${{ matrix.shardIndex }} of ${{ matrix.shardTotal }}
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.53.0-noble
      options: --user 1001
    strategy:
      matrix:
        shardIndex: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]
        shardTotal: [20]
    steps:
      # --- Source Control Checkout ---
      - name: ⬇️ Checkout Source Code
        uses: actions/checkout@v4

      # --- Node.js Dependency Caching for Performance ---
      - name: 📦 Cache Node.js Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # --- Node.js Environment Setup ---
      - name: 🟢 Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      # --- Install Project Dependencies ---
      - name: 📦 Install NPM Dependencies
        run: npm ci

      # --- Execute Playwright Tests with Sharding, Retries, and Allure Reporting ---
      - name: 🧪 Execute Playwright E2E Tests (Sharded, Allure, Screenshots, Videos)
        run: |
          npx playwright test \
            --retries=2 \
            --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }} \
            --reporter=allure-playwright,line,github

      # --- Upload Allure Results for Each Shard ---
      - name: 📤 Upload Allure Results (Shard)
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-shard-${{ matrix.shardIndex }}
          path: allure-results/
          retention-days: 7

  # -----------------------------------------------------------------------------
  # 2. Allure Results Aggregation and HTML Report Generation
  # -----------------------------------------------------------------------------
  build-allure:
    name: 🛠️ Aggregate Allure Results & Generate HTML Report
    needs: playwright
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.53.0-noble
      options: --user 1001
    steps:
      # --- Source Control Checkout ---
      - name: ⬇️ Checkout Source Code
        uses: actions/checkout@v4

      # --- Download Allure Results from All Shards ---
      - name: ⬇️ Download Allure Results Artifacts
        uses: actions/download-artifact@v4
        with:
          path: merged-allure-results

      # --- Download previous Allure history artifact, if it exists ---
      - name: 📥 Download Allure History Artifact
        if: always()
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: allure-history
          path: allure-history

      # --- Restore .history directory into allure-results ---
      - name: ♻️ Restore Allure History for Trend Charts
        if: always()
        run: |
          if [ -d allure-history/history ]; then
            cp -r allure-history/history allure-results/
          fi

      # List for debugging
      - name: 🕵️ List allure-results before generate
        run: ls -lR allure-results

      # --- Node.js Environment Setup ---
      - name: 🟢 Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      # --- Install Project Dependencies ---
      - name: 📦 Install NPM Dependencies
        run: npm ci

      # --- Java Environment Setup for Allure CLI ---
      - name: ☕ Setup Java Runtime for Allure CLI
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # --- Allure Results Merge (Preserve Structure) ---
      - name: 🗃️ Merge Allure Results from All Shards (Preserve Attachments)
        run: |
          mkdir -p allure-results
          for d in merged-allure-results/*; do
            cp -r "$d/." allure-results/
          done

      # --- Generate Allure HTML Report (with Attachments) ---
      - name: 🏗️ Generate Allure HTML Report
        run: npx allure generate allure-results --clean -o public

      # --- Upload new Allure history for next run ---
      - name: 📤 Upload Allure History Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-history
          path: public/.history
          retention-days: 7

      # --- List Final Report Directory for Auditability ---
      - name: 📂 List Allure Report Directory
        run: find ./public

      # --- Upload Allure HTML Report as Artifact for Retention ---
      - name: 📤 Upload Allure HTML Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: public/
          retention-days: 30

  # -----------------------------------------------------------------------------
  # 3. Automated Deployment of Allure Report to GitHub Pages
  # -----------------------------------------------------------------------------
  deploy-pages:
    name: 🚀 Deploy Allure Report to GitHub Pages
    needs: build-allure
    permissions:
      contents: read
      pages: write
      id-token: write
    runs-on: ubuntu-latest
    steps:
      # --- Source Control Checkout ---
      - name: ⬇️ Checkout Source Code
        uses: actions/checkout@v4

      # --- Download Allure HTML Report Artifact ---
      - name: ⬇️ Download Allure Report Artifact
        uses: actions/download-artifact@v4
        with:
          name: allure-report
          path: public

      # --- List Final Report Directory for Auditability ---
      - name: 📂 List Allure Report Directory
        run: find ./public

      # --- Configure GitHub Pages Deployment Environment ---
      - name: ⚙️ Configure GitHub Pages
        uses: actions/configure-pages@v5

      # --- Upload Artifact for GitHub Pages Deployment ---
      - name: 📤 Upload Artifact for Pages Deployment
        uses: actions/upload-pages-artifact@v3
        with:
          path: './public'

      # --- Deploy to GitHub Pages ---
      - name: 🚀 Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # --- Post Test Summary to GitHub Actions UI ---
      - name: 📝 Post Test Summary
        if: always()
        run: |
          echo "### :bar_chart: [Allure Test Report](https://paul1404.github.io/elecalculate/)" >> $GITHUB_STEP_SUMMARY